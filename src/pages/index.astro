---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Icon from "../components/Icons.astro";
import ProjectPreview from "../components/ProjectPreview.astro";
import FormattedDate from "../components/FormattedDate.astro";
import ClientScripts from "../components/ClientScripts.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getProjects, getHighlightConfig } from "../utils/projects";
import { getCollection } from "astro:content";
import "../styles/pages/blog.css";
import "../styles/pages/blog-index.css";

const [projects, highlights, labsCollection, essaysCollection] =
  await Promise.all([
    getProjects(),
    getHighlightConfig(),
    getCollection("labs"),
    getCollection("essays"),
  ]);

const entrySlug = (id: string) => id.replace(/\\/g, "/").replace(/\.mdx?$/, "");

const nonNullable = <T,>(value: T | null | undefined): value is T =>
  value !== null && value !== undefined;

const projectMap = new Map(projects.map((project) => [project.slug, project]));

const highlightedProjectSlugs = new Set(
  highlights.projects.map((ref) => ref.slug),
);

const highlightedProjects = highlights.projects
  .map((ref) => projectMap.get(ref.slug))
  .filter(nonNullable);

const fallbackProjects = [...projects].sort((a, b) => {
  const aDate = a.updatedDate ?? a.pubDate ?? "";
  const bDate = b.updatedDate ?? b.pubDate ?? "";
  if (!aDate && !bDate) return a.name.localeCompare(b.name);
  return new Date(bDate).getTime() - new Date(aDate).getTime();
});

const projectsToShow =
  highlightedProjects.length > 0
    ? highlightedProjects.slice(0, 3)
    : fallbackProjects.slice(0, 3);

const labsBySlug = new Map(
  labsCollection.map((entry) => [entrySlug(entry.id), entry]),
);
const essaysBySlug = new Map(
  essaysCollection.map((entry) => [entrySlug(entry.id), entry]),
);

const labsSorted = [...labsCollection].sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const essaysSorted = [...essaysCollection].sort((a, b) => {
  const dateA = a.data.pubDate ?? a.data.updatedDate ?? new Date(0);
  const dateB = b.data.pubDate ?? b.data.updatedDate ?? new Date(0);
  return dateB.valueOf() - dateA.valueOf();
});

const labsToShow =
  highlights.labs.length > 0
    ? highlights.labs.map((ref) => labsBySlug.get(ref.slug)).filter(nonNullable)
    : labsSorted.slice(0, 3);

const essaysToShow =
  highlights.essays.length > 0
    ? highlights.essays
        .map((ref) => essaysBySlug.get(ref.slug))
        .filter(nonNullable)
    : essaysSorted.slice(0, 3);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <ClientScripts />
  </head>
  <body>
    <Header />

    <!-- Tooltip element for JS interactions -->
    <div id="tooltip"></div>
    <main>
      <section id="about" class="bg-primary">
        <h2 class="u-heading-font">About Me</h2>
        <p>
          Currently, I'm exploring ML for audio-visual content generation,
          translation, durable execution, reactive programming, and
          collaborative products (similar to tools like Figma or Google Docs).
          Feel free to reach out if you'd like to discuss these topics.
        </p>
      </section>
      <section id="contact">
        <h2>Follow & Connect</h2>
        <p>
          <!-- <a
            href="https://x.com/ouatu_ro"
            target="_blank"
            class="inline-icon-link"
          >
            <Icon name="twitter" /> Follow me on Twitter
          </a> | -->
          <a
            href="https://www.linkedin.com/in/bogdan-ouatu-2788a1b7/"
            target="_blank"
            class="inline-icon-link"
          >
            <Icon name="linkedin" /> Follow me on LinkedIn
          </a>
        </p>
      </section>
      <section id="essays">
        <h2>
          <a href="/essays" class="blog-title-link">Essays</a>
          <a href="/essays-rss.xml" class="rss-link" title="Essays RSS Feed">
            <Icon name="rss" />
          </a>
        </h2>
        <p>
          Longer reflections and opinion pieces
          <a href="/essays" class="blog-link">Read the essays</a>
        </p>
        {
          essaysToShow.length > 0 ? (
            <ul class="blog-index-list blog-index-list--compact">
              {essaysToShow.map((essay) => (
                <li>
                  <a href={`/essays/${entrySlug(essay.id)}/`}>
                    {essay.data.heroImage ? (
                      <img
                        width={720}
                        height={360}
                        src={essay.data.heroImage}
                        alt=""
                      />
                    ) : (
                      <div class="blog-title-fallback">
                        <h3>{essay.data.title}</h3>
                      </div>
                    )}
                    <h4 class="title blog-index-title">{essay.data.title}</h4>
                    {(essay.data.pubDate || essay.data.updatedDate) && (
                      <p class="date blog-index-date">
                        <FormattedDate
                          date={essay.data.pubDate ?? essay.data.updatedDate!}
                        />
                      </p>
                    )}
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p>No essays published yet. Check back soon!</p>
          )
        }
      </section>
      <section id="labs">
        <h2>
          <a href="/labs" class="blog-title-link">Labs</a>
          <a href="/labs-rss.xml" class="rss-link" title="Labs RSS Feed">
            <Icon name="rss" />
          </a>
        </h2>
        <p>
          Explore my latest experiments and write-ups
          <a href="/labs" class="blog-link">Visit the labs</a>
        </p>
        <ul
          class="blog-index-list blog-index-list--compact blog-index-list--labs-home"
        >
          {
            labsToShow.map((lab) => (
              <li>
                <a href={`/labs/${entrySlug(lab.id)}/`}>
                  {lab.data.heroImage ? (
                    <img
                      width={720}
                      height={360}
                      src={lab.data.heroImage}
                      alt=""
                    />
                  ) : (
                    <div class="blog-title-fallback">
                      <h3>{lab.data.title}</h3>
                    </div>
                  )}
                  <h4 class="title blog-index-title">{lab.data.title}</h4>
                  <p class="date blog-index-date">
                    <FormattedDate date={lab.data.pubDate} />
                  </p>
                </a>
              </li>
            ))
          }
        </ul>
      </section>
      <section id="projects">
        <h2>
          <a href="/projects" class="blog-title-link">Projects</a>
          <a
            href="/projects-rss.xml"
            class="rss-link"
            title="Projects RSS Feed"
          >
            <Icon name="rss" />
          </a>
        </h2>
        <p>
          Snapshot of current favourites. Browse the{" "}
          <a href="/projects" class="blog-link">full projects archive</a> for every
          launch and experiment.
        </p>
        <ul class="projects-highlight-grid projects-highlight-grid--home">
          {
            projectsToShow.map((project) => (
              <ProjectPreview
                project={project}
                highlighted={highlightedProjectSlugs.has(project.slug)}
              />
            ))
          }
        </ul>
      </section>
    </main>

    <Footer />

    <!-- SEO footer with direct project links - rendered server-side -->
    <div class="seo-footer">
      <div class="container">
        <h3>Explore Projects</h3>
        <div class="seo-project-links">
          {
            projects.map((project) => (
              <a
                href={project.homepage}
                class="seo-project-link"
                target="_blank"
                rel="noopener"
              >
                {project.name}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </body>
</html>
