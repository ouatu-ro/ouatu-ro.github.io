---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Icon from "../components/Icons.astro";
import { SITE_TITLE, SITE_DESCRIPTION, CONTACT_EMAIL } from "../consts";
import fs from "node:fs";
import path from "node:path";
import { slugify } from "../utils/slugify";
import ClientScripts from "../components/ClientScripts.astro";

// Define Project interface
interface Project {
  name: string;
  homepage: string;
  description: string;
  githubUrl: string | null;
  slug?: string;
}

// Helper function to read projects data
function readProjectsData(): Project[] {
  try {
    const projectsFilePath = path.join(
      process.cwd(),
      "public",
      "projects-data.json",
    );
    if (fs.existsSync(projectsFilePath)) {
      const data = JSON.parse(fs.readFileSync(projectsFilePath, "utf8"));
      return data.projects || [];
    }
    console.warn("projects-data.json does not exist, trying manual projects");
  } catch (error) {
    console.warn("Could not read projects-data.json:", error);
  }

  // Try reading manual projects as fallback
  try {
    const manualProjectsPath = path.join(
      process.cwd(),
      "public",
      "manual-projects-data.json",
    );
    if (fs.existsSync(manualProjectsPath)) {
      const data = JSON.parse(fs.readFileSync(manualProjectsPath, "utf8"));
      return data.manualProjects || [];
    }
    console.warn("manual-projects-data.json does not exist");
  } catch (error) {
    console.warn("Could not read manual-projects-data.json:", error);
  }

  // If nothing found, return empty array
  console.error(
    "No projects found! Please ensure the GitHub Action has generated the projects-data.json file.",
  );
  return [];
}

// Get projects at build time
const projects = readProjectsData().map((project) => ({
  ...project,
  slug: project.slug || slugify(project.name),
}));

console.log(`Loaded ${projects.length} projects for the homepage`);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <ClientScripts />
  </head>
  <body>
    <Header />

    <!-- Tooltip element for JS interactions -->
    <div id="tooltip"></div>
    <main>
      <section id="about" class="bg-primary">
        <h2 class="u-heading-font">About Me</h2>
        <p>
          Currently, I'm exploring ML for audio-visual content generation,
          translation, durable execution, reactive programming, and
          collaborative products (similar to tools like Figma or Google Docs).
          Feel free to reach out if you'd like to discuss these topics.
        </p>
      </section>
      <section id="contact">
        <h2>Follow & Connect</h2>
        <p>
          <!-- <a
            href="https://x.com/ouatu_ro"
            target="_blank"
            class="inline-icon-link"
          >
            <Icon name="twitter" /> Follow me on Twitter
          </a> | -->
          <a
            href="https://www.linkedin.com/in/bogdan-ouatu-2788a1b7/"
            target="_blank"
            class="inline-icon-link"
          >
            <Icon name="linkedin" /> Follow me on LinkedIn
          </a>
        </p>
      </section>
      <section id="projects">
        <h2>
          Projects <a
            href="/projects-rss.xml"
            class="rss-link"
            title="Projects RSS Feed"><Icon name="rss" /></a
          >
        </h2>
        <p>
          Here are some fully fledged products and proofs-of-concept I built.
          This list is dynamically generated from my GitHub repositories
          directly into this website.
        </p>
        <ul id="projects-list">
          {
            projects.length > 0 ? (
              projects.map((project) => (
                <li>
                  <div class="project-link-wrapper">
                    <a href={`/project/${project.slug}`}>{project.name}</a>
                    {project.description && (
                      <button
                        class="info-btn"
                        aria-label="Show project description"
                      >
                        <Icon name="info-circle" />
                      </button>
                    )}
                  </div>
                  {project.description && (
                    <div class="project-description">{project.description}</div>
                  )}
                </li>
              ))
            ) : (
              <li class="no-projects-message">
                <p>
                  Projects are currently being updated. Please check back soon!
                </p>
              </li>
            )
          }
        </ul>
      </section>
      <section id="labs">
        <h2>
          <a href="/labs" class="blog-title-link">Labs</a>
          <a href="/labs-rss.xml" class="rss-link" title="Labs RSS Feed">
            <Icon name="rss" />
          </a>
        </h2>
        <p>
          Explore my latest experiments and write-ups
          <a href="/labs" class="blog-link">Visit the labs</a>
        </p>
      </section>
      <section id="essays">
        <h2>
          <a href="/essays" class="blog-title-link">Essays</a>
          <a href="/essays-rss.xml" class="rss-link" title="Essays RSS Feed">
            <Icon name="rss" />
          </a>
        </h2>
        <p>
          Longer reflections and opinion pieces
          <a href="/essays" class="blog-link">Read the essays</a>
        </p>
      </section>
    </main>

    <Footer />

    <!-- SEO footer with direct project links - rendered server-side -->
    <div class="seo-footer">
      <div class="container">
        <h3>Explore Projects</h3>
        <div class="seo-project-links">
          {
            projects.map((project) => (
              <a
                href={project.homepage}
                class="seo-project-link"
                target="_blank"
                rel="noopener"
              >
                {project.name}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </body>
</html>
