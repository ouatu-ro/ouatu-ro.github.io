---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Icon from "../components/Icons.astro";
import ProjectPreview from "../components/ProjectPreview.astro";
import FormattedDate from "../components/FormattedDate.astro";
import ClientScripts from "../components/ClientScripts.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getProjects, getHighlightConfig } from "../utils/projects";
import { getAllPosts, type BlogPost } from "../lib/posts";
import "../styles/pages/blog.css";
import "../styles/pages/blog-index.css";

const [projects, highlights, blogPosts] = await Promise.all([
  getProjects(),
  getHighlightConfig(),
  getAllPosts(),
]);

const nonNullable = <T,>(value: T | null | undefined): value is T =>
  value !== null && value !== undefined;
const projectMap = new Map(projects.map((project) => [project.slug, project]));
const highlightedProjectSlugs = new Set(
  highlights.projects.map((ref) => ref.slug),
);
const highlightedProjects = highlights.projects
  .map((ref) => projectMap.get(ref.slug))
  .filter(nonNullable);
const fallbackProjects = [...projects].sort((a, b) => {
  const aDate = a.updatedDate ?? a.pubDate ?? "";
  const bDate = b.updatedDate ?? b.pubDate ?? "";
  if (!aDate && !bDate) return a.name.localeCompare(b.name);
  return new Date(bDate).getTime() - new Date(aDate).getTime();
});
const projectsToShow =
  highlightedProjects.length > 0
    ? highlightedProjects.slice(0, 3)
    : fallbackProjects.slice(0, 3);
const postsBySlug = new Map(blogPosts.map((post) => [post.slug, post]));
const highlightedPosts =
  highlights.posts.length > 0
    ? highlights.posts
        .map((ref) => postsBySlug.get(ref.slug))
        .filter(nonNullable)
    : [];
const postsToShow =
  highlightedPosts.length > 0
    ? highlightedPosts.slice(0, 3)
    : (blogPosts.slice(0, 3) as BlogPost[]);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <ClientScripts />
  </head>
  <body>
    <Header />

    <div id="tooltip"></div>
    <main>
      <section id="about" class="bg-primary">
        <h2 class="u-heading-font">About Me</h2>
        <p>
          I think about complex systems. I write essays when I find something
          valuable.
        </p>
      </section>

      <section id="blog">
        <h2>
          <a href="/blog" class="blog-title-link">Blog</a>
          <a href="/blog/rss.xml" class="rss-link" title="Blog RSS Feed">
            <Icon name="rss" />
          </a>
          <!-- <a href="/blog/feed.json" class="rss-link" title="Blog JSON Feed">
            <Icon name="rss" />
          </a> -->
        </h2>
        <p>
          Every lab, essay, and catalogue entry now lives together.
          <a href="/blog" class="blog-link">Browse the full archive</a>
        </p>
        <ul class="blog-index-list blog-index-list--home">
          {
            postsToShow.map((post) => (
              <li class="blog-card">
                <a class="blog-card__link" href={`/blog/${post.slug}/`}>
                  <p class="blog-card__meta">
                    <FormattedDate date={post.data.pubDate} /> Â·{" "}
                    {post.readingTime} min read
                  </p>
                  <h3 class="blog-card__title">{post.data.title}</h3>
                  <p class="blog-card__description">{post.data.description}</p>
                  {post.normalizedTags.length > 0 && (
                    <div class="blog-card__tags">
                      {post.normalizedTags.map((tag) => (
                        <span class="blog-card__tag">#{tag.label}</span>
                      ))}
                    </div>
                  )}
                </a>
              </li>
            ))
          }
        </ul>
      </section>

      <section id="projects">
        <h2>
          <a href="/projects" class="blog-title-link">Projects</a>
          <a
            href="/projects-rss.xml"
            class="rss-link"
            title="Projects RSS Feed"
          >
            <Icon name="rss" />
          </a>
        </h2>
        <p>
          A collection of my joy-driven projects. Browse the{" "}
          <a href="/projects" class="blog-link">full projects archive</a> for every
          launch and experiment.
        </p>
        <ul class="projects-highlight-grid projects-highlight-grid--home">
          {
            projectsToShow.map((project) => (
              <ProjectPreview
                project={project}
                highlighted={highlightedProjectSlugs.has(project.slug)}
              />
            ))
          }
        </ul>
      </section>

      <section id="contact">
        <h2>Get In Touch</h2>
        <p>Write to discuss ideas or request technical consulting.</p>
        <div class="contact-links">
          <!-- REFINED EMAIL -->
          <a href="mailto:hello@ouatu.ro" class="btn btn-primary">
            Email Me: hello<span style="display: none;">-</span>@<span
              style="display: none;">-</span
            >ouatu.ro
          </a>
          <a
            href="https://www.linkedin.com/in/bogdan-ouatu-2788a1b7/"
            target="_blank"
            class="btn btn-secondary"
          >
            <Icon name="linkedin" />
            Connect on LinkedIn
          </a>
        </div>
      </section>
    </main>

    <Footer />

    <div class="seo-footer">
      <div class="container">
        <h3>Explore Projects</h3>
        <div class="seo-project-links">
          {
            projects.map((project) => (
              <a
                href={project.homepage}
                class="seo-project-link"
                target="_blank"
                rel="noopener"
              >
                {project.name}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </body>
</html>

<style>
  .contact-links {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
