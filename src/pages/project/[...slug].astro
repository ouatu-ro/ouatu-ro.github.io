---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import type { ProjectRecord } from "../../utils/projects";
import { getProjects } from "../../utils/projects";
import { SITE_TITLE, AUTHOR, AUTHOR_TITLE } from "../../consts";
import ClientScripts from "../../components/ClientScripts.astro";
import { getCollection } from "astro:content";
import MarkdownIt from "markdown-it";
import sanitizeHtml from "sanitize-html";
import Icon from "../../components/Icons.astro";
import "../../styles/pages/project-detail.css";
import "../../styles/components/project-preview.css";
import {
  buildProjectArtworkContext,
  previewComponentMap,
} from "../../components/project-artwork-context";

export async function getStaticPaths() {
  const projects = await getProjects();
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

// ---- now it's safe to access props
const { project } = Astro.props as { project: ProjectRecord };

// Load matching extra snippet (optional)
const extras = await getCollection("projectsExtra");
const extra = extras.find((e) => e.data.slug === project.slug);

const extraPreviewAsset = extra?.data.projectPreview;
const previewAsset = project.previewAsset ?? extraPreviewAsset;
const previewFlag =
  project.shouldShowPreview ?? extra?.data.shouldShowPreview ?? false;
const hasPreview = Boolean(previewFlag && previewAsset);
const hasHero = project.slug === "maze-solver" ? hasPreview : true;
const assetIsVideo = previewAsset
  ? /\.(mp4|webm|mov|m4v)$/i.test(previewAsset)
  : false;
const assetIsImage = previewAsset
  ? /\.(png|jpe?g|gif|webp|avif)$/i.test(previewAsset)
  : false;
const mediaAvailable = Boolean(previewAsset && (assetIsVideo || assetIsImage));

const artworkContext = buildProjectArtworkContext(project);
const {
  previewType,
  trimmedDescription,
  promptName,
  pascalName,
  terminalLines,
  codeLines,
  blueprintNodes,
  blueprintConnectors,
  graphNodes,
  graphLinks,
} = artworkContext;

// Render MD/MDX body safely
let extraHtml: string | null = null;
if (extra?.body) {
  const md = new MarkdownIt({ html: true, linkify: true });
  const rawHtml = md.render(extra.body);
  extraHtml = sanitizeHtml(rawHtml, {
    allowedTags: sanitizeHtml.defaults.allowedTags.concat([
      "img",
      "h2",
      "h3",
      "code",
      "pre",
    ]),
    allowedAttributes: {
      ...sanitizeHtml.defaults.allowedAttributes,
      img: ["src", "alt", "title", "width", "height", "loading"],
      a: ["href", "name", "target", "rel", "title"],
    },
  });
}

// Utility to linkify URLs in text
function linkify(text: string): string {
  return text.replace(
    /(https?:\/\/[^\s]+)/g,
    (url) =>
      `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`,
  );
}

const pageTitle = `${project.name} - ${SITE_TITLE}`;
const richDescription = `${project.description} - A project by ${AUTHOR}, ${AUTHOR_TITLE}.`;

const pubDate = project.pubDate
  ? new Date(project.pubDate).toISOString()
  : new Date().toISOString();
const updatedDate = project.updatedDate
  ? new Date(project.updatedDate).toISOString()
  : pubDate;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: project.name,
  description: project.description,
  author: { "@type": "Person", name: AUTHOR, jobTitle: AUTHOR_TITLE },
  url: project.homepage,
  datePublished: pubDate,
  dateModified: updatedDate,
  ...(project.githubUrl && { codeRepository: project.githubUrl }),
  applicationCategory: "WebApplication",
  operatingSystem: "Any",
};
---

<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={richDescription} />
    <ClientScripts />

    <!-- Structured data for better SEO -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />
  </head>
  <body>
    <Header />
    <main class:list={["project-container", { "no-preview": !hasHero }]}>
      <section class="project-hero">
        {
          project.slug === "maze-solver" && hasPreview ? (
            <div class="preview-wrapper">
              <div class="phone-frame">
                <div class="phone-frame__bezel">
                  <a
                    href={project.homepage}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="mobile-preview"
                    aria-label={`Launch a fullscreen demo of ${project.name} (opens in a new tab)`}
                  >
                    <video
                      autoplay
                      loop
                      muted
                      playsinline
                      src={previewAsset}
                      aria-label={`Animated preview of ${project.name}`}
                    >
                      Your browser does not support the video tag.
                    </video>
                    <span class="play-icon-overlay">
                      <Icon name="external-link" />
                      <span>Launch App</span>
                    </span>
                  </a>
                </div>
              </div>
            </div>
          ) : (
            (() => {
              const ArtworkComponent =
                previewComponentMap[
                  previewType as keyof typeof previewComponentMap
                ] ?? previewComponentMap.titlecard;
              return (
                <a
                  class="project-card-link project-card-link--hero"
                  href={project.homepage}
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label={`Open ${project.name}`}
                >
                  <div
                    class={`project-card-media project-card-media--fallback project-card-media--${previewType}`}
                  >
                    <ArtworkComponent
                      project={project}
                      trimmedDescription={trimmedDescription}
                      promptName={promptName}
                      pascalName={pascalName}
                      terminalLines={terminalLines}
                      codeLines={codeLines}
                      blueprintNodes={blueprintNodes}
                      blueprintConnectors={blueprintConnectors}
                      graphNodes={graphNodes}
                      graphLinks={graphLinks}
                      label={project.name.slice(0, 2).toUpperCase()}
                      title={project.name}
                      subtitle={trimmedDescription}
                      domain={project.homepage || project.name}
                    />
                  </div>
                </a>
              );
            })()
          )
        }
      </section>

      <div class="project-header">
        <h1>{project.name}</h1>
        <div class="project-description">
          <p set:html={linkify(project.description)} />
        </div>
        <div class="project-links">
          <a
            href={project.homepage}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-primary"
            aria-label={`Open ${project.name} in a new tab`}
          >
            Open in New Tab
            <Icon name="external-link" />
          </a>
          {
            project.githubUrl && (
              <a
                href={project.githubUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-secondary"
                aria-label={`View ${project.name} on GitHub (opens in a new tab)`}
              >
                <Icon name="github" />
                View on GitHub
              </a>
            )
          }
        </div>
      </div>

      <div
        class:list={["project-metadata", { "fade-in-on-scroll": hasHero }]}
        data-has-preview={hasHero}
      >
        <h2>About this project</h2>
        <p set:html={linkify(project.description)} />

        {extraHtml && <div set:html={extraHtml} />}
        {
          project.githubUrl && (
            <p>
              This is an open-source project. Feel free to explore the source
              code on
              <a
                href={project.githubUrl}
                target="_blank"
                rel="noopener noreferrer"
              >
                {" "}
                GitHub
              </a>
              .
            </p>
          )
        }
      </div>
    </main>
    <Footer />
    <script>
      (() => {
        const root = document.documentElement;
        root.classList.add("js-ready");

        const target = document.querySelector(".project-metadata");
        if (!(target instanceof HTMLElement)) return;

        const hasPreview = target.dataset.hasPreview === "true";
        if (!hasPreview) return;

        const reveal = () => {
          requestAnimationFrame(() => {
            target.classList.add("is-visible");
          });
        };

        if (!("IntersectionObserver" in window)) {
          reveal();
          return;
        }

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                reveal();
                observer.disconnect();
              }
            });
          },
          { threshold: 0.1 },
        );

        observer.observe(target);
      })();
    </script>
  </body>
</html>
