---
import type { ProjectRecord } from "../../lib/projects";
import { getAllProjects } from "../../lib/projects";
import { site } from "../../config/site";
import { getCollection } from "astro:content";
import MarkdownIt from "markdown-it";
import sanitizeHtml from "sanitize-html";
import Icon from "../../components/Icons.astro";
import "../../styles/pages/project-detail.css";
import "../../styles/components/project-preview.css";
import { previewComponentMap } from "../../components/artwork-manager";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const projects = await getAllProjects();
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props as { project: ProjectRecord };

const extras = await getCollection("projectsExtra");
const extra = extras.find((e) => e.data.slug === project.slug);

const previewAsset = project.previewAsset;
const previewFlag = project.shouldShowPreview ?? false;
const hasPreview = Boolean(previewFlag && previewAsset);
const hasHero = project.slug === "maze-solver" ? hasPreview : true;
const fallbackPreviewType = previewComponentMap[project.previewType]
  ? project.previewType
  : "titlecard";
const ArtworkComponent =
  previewComponentMap[
    fallbackPreviewType as keyof typeof previewComponentMap
  ] ?? previewComponentMap.titlecard;

const mainClassNames = ["project-container"];
if (!hasHero) mainClassNames.push("no-preview");
const mainClass = mainClassNames.join(" ");

let extraHtml: string | null = null;
if (extra?.body) {
  const md = new MarkdownIt({ html: true, linkify: true });
  const rawHtml = md.render(extra.body);
  extraHtml = sanitizeHtml(rawHtml, {
    allowedTags: sanitizeHtml.defaults.allowedTags.concat([
      "img",
      "h2",
      "h3",
      "code",
      "pre",
    ]),
    allowedAttributes: {
      ...sanitizeHtml.defaults.allowedAttributes,
      img: ["src", "alt", "title", "width", "height", "loading"],
      a: ["href", "name", "target", "rel", "title"],
    },
  });
}

function linkify(text: string): string {
  return text.replace(
    /(https?:\/\/[^\s]+)/g,
    (url) =>
      `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`,
  );
}

const pageTitle = `${project.name} - ${site.title}`;
const richDescription = `${project.description} - A project by ${site.author}, ${site.authorTitle}.`;

const pubDate = project.pubDate
  ? new Date(project.pubDate).toISOString()
  : new Date().toISOString();
const updatedDate = project.updatedDate
  ? new Date(project.updatedDate).toISOString()
  : pubDate;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: project.name,
  description: project.description,
  author: {
    "@type": "Person",
    name: site.author,
    jobTitle: site.authorTitle,
  },
  url: project.homepage,
  datePublished: pubDate,
  dateModified: updatedDate,
  ...(project.githubUrl && { codeRepository: project.githubUrl }),
  applicationCategory: "WebApplication",
  operatingSystem: "Any",
};
---

<BaseLayout
  title={pageTitle}
  description={richDescription}
  mainClass={mainClass}
>
  <Fragment slot="head">
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />
  </Fragment>

  <section class="project-hero">
    {
      project.slug === "maze-solver" && hasPreview ? (
        <div class="preview-wrapper">
          <div class="phone-frame">
            <div class="phone-frame__bezel">
              <a
                href={project.homepage}
                target="_blank"
                rel="noopener noreferrer"
                class="mobile-preview"
                aria-label={`Launch a fullscreen demo of ${project.name} (opens in a new tab)`}
              >
                <video
                  autoplay
                  loop
                  muted
                  playsinline
                  src={previewAsset}
                  aria-label={`Animated preview of ${project.name}`}
                >
                  Your browser does not support the video tag.
                </video>
                <span class="play-icon-overlay">
                  <Icon name="external-link" />
                  <span>Launch App</span>
                </span>
              </a>
            </div>
          </div>
        </div>
      ) : (
        <a
          class="project-card-link project-card-link--hero"
          href={project.homepage}
          target="_blank"
          rel="noopener noreferrer"
          aria-label={`Open ${project.name}`}
        >
          <div
            class={`project-card-media project-card-media--fallback project-card-media--${fallbackPreviewType}`}
          >
            <ArtworkComponent project={project} />
          </div>
        </a>
      )
    }
  </section>

  <div class="project-header">
    <h1>{project.name}</h1>
    <div class="project-description">
      <p set:html={linkify(project.description)} />
    </div>
    <div class="project-links">
      <a
        href={project.homepage}
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-primary"
        aria-label={`Open ${project.name} in a new tab`}
      >
        Open in New Tab
        <Icon name="external-link" />
      </a>
      {
        project.githubUrl && (
          <a
            href={project.githubUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-secondary"
            aria-label={`View ${project.name} on GitHub (opens in a new tab)`}
          >
            <Icon name="github" />
            View on GitHub
          </a>
        )
      }
    </div>
  </div>

  <div
    class:list={["project-metadata", { "fade-in-on-scroll": hasHero }]}
    data-has-preview={hasHero}
  >
    <h2>About this project</h2>
    <p set:html={linkify(project.description)} />

    {extraHtml && <div set:html={extraHtml} />}
    {
      project.githubUrl && (
        <p>
          This is an open-source project. Feel free to explore the source code
          on
          <a href={project.githubUrl} target="_blank" rel="noopener noreferrer">
            {" "}
            GitHub
          </a>
          .
        </p>
      )
    }
  </div>

  <Fragment slot="foot">
    <script is:inline>
      {
        `(() => {
  const root = document.documentElement;
  root.classList.add("js-ready");

  const target = document.querySelector(".project-metadata");
  if (!(target instanceof HTMLElement)) return;

  const hasPreview = target.dataset.hasPreview === "true";
  if (!hasPreview) return;

  const reveal = () => {
    requestAnimationFrame(() => {
      target.classList.add("is-visible");
    });
  };

  if (!("IntersectionObserver" in window)) {
    reveal();
    return;
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          reveal();
          observer.disconnect();
        }
      });
    },
    { threshold: 0.1 },
  );

  observer.observe(target);
})();`;
      }
    </script>
  </Fragment>
</BaseLayout>
