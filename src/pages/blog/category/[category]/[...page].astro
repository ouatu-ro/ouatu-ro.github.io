---
import type { GetStaticPaths } from "astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import FormattedDate from "@/components/FormattedDate.astro";
import SubscribePrompt from "@/components/SubscribePrompt.astro";
import Icon from "@/components/Icons.astro";
import CategoryTabs from "@/components/CategoryTabs.astro";
import { POSTS_PER_PAGE } from "@/config/constants";
import {
  CATEGORY_IDS,
  CATEGORIES,
  type CategoryId,
} from "@/config/categories";
import { getPostsByCategory, type BlogPost } from "@/lib/posts";
import "@/styles/pages/blog.css";
import "@/styles/pages/blog-index.css";

export const getStaticPaths = (async ({ paginate }) => {
  const paths = [];
  for (const category of CATEGORY_IDS) {
    const posts = await getPostsByCategory(category as CategoryId);
    if (posts.length === 0) continue;
    paths.push(
      ...paginate(posts, {
        pageSize: POSTS_PER_PAGE,
        props: { category },
        params: { category },
      })
    );
  }
  return paths;
}) satisfies GetStaticPaths;

const { page, category } = Astro.props as {
  page: {
    data: BlogPost[];
    currentPage: number;
    lastPage: number;
    url: { prev?: string; next?: string };
  };
  category: CategoryId;
};
const posts = page.data;
const categoryMeta = CATEGORIES[category];
const title = `${categoryMeta.name} Posts${page.currentPage === 1 ? "" : ` – Page ${page.currentPage}`}`;
const description = categoryMeta.description;
const feedBase = `/blog/category/${category}`;
---

<BaseLayout title={title} description={description} mainClass="blog-index-main">
  <section class="blog-index-header">
    <div>
      <h1 class="u-heading-font">{categoryMeta.name}</h1>
      <p class="lede">{categoryMeta.description}</p>
    </div>
    <div class="blog-index-subscribe">
      <a href={`${feedBase}/rss.xml`} class="rss-link" title="Category RSS">
        <Icon name="rss" /> RSS
      </a>
      <a href={`${feedBase}/feed.json`} class="rss-link" title="Category JSON feed">
        <Icon name="rss" /> JSON
      </a>
    </div>
  </section>
  <CategoryTabs activeCategory={category} />
  <section>
    <ul class="blog-index-list">
      {posts.map((post) => (
        <li>
          <a href={`/blog/${post.slug}/`}>
            {post.data.heroImage ? (
              <img width={720} height={360} src={post.data.heroImage} alt="" loading="lazy" />
            ) : (
              <div class="blog-title-fallback">
                <h3>{post.data.title}</h3>
              </div>
            )}
            <h4 class="title blog-index-title">{post.data.title}</h4>
            <p class="date blog-index-date">
              <FormattedDate date={post.data.pubDate} /> · {post.readingTime} min read
            </p>
          </a>
        </li>
      ))}
    </ul>
  </section>
  <nav class="pagination" aria-label={`${categoryMeta.name} pagination`}>
    {page.url.prev && <a href={page.url.prev}>Previous</a>}
    <span>
      Page {page.currentPage} of {page.lastPage}
    </span>
    {page.url.next && <a href={page.url.next}>Next</a>}
  </nav>
  <SubscribePrompt categoryId={category} />
</BaseLayout>
