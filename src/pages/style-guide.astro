---
import Icon from "../components/Icons.astro";
import ProjectPreview from "../components/ProjectPreview.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { Code } from "astro/components";
import { ICONS } from "../components/icons.data";
import { blog as blogConfig, type CategoryId } from "../config/site";
import { getAllProjects, type ProjectRecord } from "../lib/projects";
import { getAllPosts } from "../lib/posts";
import resumeData from "../content/resume/resume.json";
import katex from "katex";
import "katex/dist/katex.min.css";
import "../styles/pages/style-guide.css";
import "../styles/pages/blog-index.css";
import "../styles/pages/resume.css";
import BaseLayout from "../layouts/BaseLayout.astro";

const colorSwatches = [
  {
    name: "--color-bg",
    label: "Background",
    modifier: "p-style-guide-swatch--bg",
  },
  {
    name: "--color-surface",
    label: "Surface panels",
    modifier: "p-style-guide-swatch--surface",
  },
  {
    name: "--color-text",
    label: "Body text",
    modifier: "p-style-guide-swatch--text",
  },
  {
    name: "--color-muted",
    label: "Secondary text",
    modifier: "p-style-guide-swatch--muted",
  },
  {
    name: "--color-primary",
    label: "Links & accents",
    modifier: "p-style-guide-swatch--primary",
  },
  {
    name: "--color-accent",
    label: "Callouts",
    modifier: "p-style-guide-swatch--accent",
  },
  {
    name: "--color-action-start",
    label: "Action Gradient Start",
    modifier: "p-style-guide-swatch--action-start",
  },
  {
    name: "--color-action-end",
    label: "Action Gradient End",
    modifier: "p-style-guide-swatch--action-end",
  },
];

const motionTimings = [
  { name: "--duration-fast", label: "Fast", value: "150ms" },
  { name: "--duration-base", label: "Base", value: "220ms" },
  { name: "--duration-slow", label: "Slow", value: "350ms" },
];

const iconEntries = Object.keys(ICONS).sort();

const pipelineCodeSample = `const fetchData = async () => {
  const response = await fetch('/api/data');
  return response.json();
};`;

const katexFormula = String.raw`\int_0^\infty e^{-x^2}\,dx = \frac{\sqrt{\pi}}{2}`;
const katexInline = String.raw`$$\int_0^\infty e^{-x^2}\,dx = \frac{\sqrt{\pi}}{2}$$`;
const katexExample = katex.renderToString(katexFormula, { displayMode: true });

const proseLines = [
  "This site carries a clear, confident voice while staying technical when it counts.",
  "Short paragraphs with inline emphasis and occasional code snippets keep each idea focused.",
  "Connections between experimental work and the visitor's curiosity live in the spacing and punctuation.",
];
const prosePreview = proseLines.map((line) => `<p>${line}</p>`).join("");

const alertSamples = [
  {
    type: "note",
    body: "The compiler notices most lints, but an explicit remark keeps people on the same page.",
  },
  {
    type: "warning",
    body: "Deploying without a release checklist risks bypassing the monitoring hooks we rely on.",
  },
];
const alertTitle = (type: string | number) =>
  ({ note: "Note", warning: "Warning" })[type] ?? "Note";
const renderAlert = (type: string, body: string) =>
  `<div class="markdown-alert markdown-alert-${type}">
    <p class="markdown-alert-title">${alertTitle(type)}</p>
    <p>${body}</p>
  </div>`;
const remarkAlertPreview = alertSamples
  .map((sample) => renderAlert(sample.type, sample.body))
  .join("");

const allProjects = await getAllProjects();
const fallbackMazeSolver = {
  name: "maze-solver",
  homepage: "https://ouatu.ro/maze-solver/",
  description:
    "Upload or photograph a black and white maze, click the start and end points on the image, and get the solution in milliseconds.",
  githubUrl: "https://github.com/ouatu-ro/maze-solver",
  slug: "maze-solver",
  pubDate: "2025-03-14T12:52:32.000Z",
  updatedDate: "2025-11-07T03:10:26.000Z",
  previewAsset: "/preview/maze-demo-720p.webm",
  shouldShowPreview: true,
  previewType: "terminal",
  isHighlight: true,
  highlightOrder: 1,
  hasExtraContent: true,
} satisfies ProjectRecord;
const mazeSolverProject =
  allProjects.find((project) => project.slug === "maze-solver") ??
  fallbackMazeSolver;

const allPosts = await getAllPosts();
type PreviewPost = {
  slug: string;
  title: string;
  description: string;
  pubDate: Date;
  readingTime: number;
  category?: string;
  tags: string[];
};
const fallbackPosts: PreviewPost[] = [
  {
    slug: "common-sense-learning",
    title: "Common-Sense Learning",
    description: "A faster and longer-lasting way to learn",
    pubDate: new Date("2025-11-10T16:00:00Z"),
    readingTime: 10,
    category: "essay",
    tags: ["learning", "cognition", "reasoning"],
  },
  {
    slug: "als",
    title:
      "Implementing Alternating Least Squares (ALS) from Scratch in Python",
    description:
      "A deep dive into building ALS for recommendation systems in Python. Includes the full derivation, a vectorized implementation, and an analysis of its real-world performance limits.",
    pubDate: new Date("2022-08-07T00:00:00Z"),
    readingTime: 22,
    category: "lab",
    tags: ["python", "machine-learning"],
  },
];
const previewPosts: PreviewPost[] = (allPosts.length ? allPosts : fallbackPosts)
  .slice(0, 2)
  .map((post) => {
    const entry = post as any;
    const pubDate =
      entry.data?.pubDate ?? entry.pubDate ?? new Date("1970-01-01T00:00:00Z");
    return {
      slug: entry.slug,
      title: entry.data?.title ?? entry.title ?? "",
      description: entry.data?.description ?? entry.description ?? "",
      pubDate: pubDate instanceof Date ? pubDate : new Date(pubDate),
      readingTime: entry.readingTime ?? 5,
      category: entry.data?.category ?? entry.category,
      tags:
        entry.normalizedTags?.map((tag: any) => tag.label) ??
        entry.data?.tags ??
        entry.tags ??
        [],
    };
  });
const getCategoryLabel = (category?: string) => {
  if (!category) return undefined;
  const meta = blogConfig.categories[category as CategoryId];
  return meta?.name ?? category;
};

const { selectedResults, experience } = resumeData;
const firstResult = selectedResults.items[0];
---

<BaseLayout
  title="Style Guide"
  description="Reference for the site's design system."
>
  <div class="p-style-guide-wrapper">
    <header class="p-style-guide-heading">
      <h1 class="u-heading-font">Design System</h1>
      <p class="p-style-guide-intro">
        A living catalog of the tokens, components, and utilities that power
        this site. Copy, paste, and remix freely.
      </p>
    </header>

    <article class="p-style-guide-card">
      <h3>Color Tokens</h3>
      <p class="p-style-guide-code">
        Defined in <code>src/styles/base/_variables.css</code>
      </p>
      <div class="p-style-guide-swatches">
        {
          colorSwatches.map(({ name, label, modifier }) => (
            <div class={`p-style-guide-swatch ${modifier}`}>
              <div class="p-style-guide-swatch-sample" />
              <div class="p-style-guide-swatch-meta">
                <strong>{name}</strong>
                <span>{label}</span>
              </div>
            </div>
          ))
        }
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Motion & Timing</h3>
      <p class="p-style-guide-code">
        Transition tokens for hovers and subtle UI shifts.
      </p>
      <div class="p-style-guide-motion-grid">
        {
          motionTimings.map((timing) => (
            <div class="p-style-guide-motion-item">
              <button
                type="button"
                class="p-style-guide-motion-tile"
                style={`--demo-duration: var(${timing.name});`}
              >
                <span>Hover or tap</span>
              </button>
              <div class="p-style-guide-motion-meta">
                <strong>{timing.label}</strong>
                <span>
                  <code>{timing.name}</code> · {timing.value}
                </span>
              </div>
            </div>
          ))
        }
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Typography Scale</h3>
      <div class="p-style-guide-type-scale">
        <div class="p-style-guide-type-item">
          <h1 class="u-heading-font">Heading 1</h1>
          <span class="p-style-guide-code"
            ><strong>Element</strong>
            <code>&lt;h1&gt;</code> · <strong>Font</strong>
            <code>var(--font-heading)</code></span
          >
        </div>
        <div class="p-style-guide-type-item">
          <h2 class="u-heading-font">Heading 2</h2>
          <span class="p-style-guide-code"
            ><strong>Element</strong>
            <code>&lt;h2&gt;</code> · <strong>Font</strong>
            <code>var(--font-heading)</code></span
          >
        </div>
        <div class="p-style-guide-type-item">
          <h3 class="u-heading-font">Heading 3</h3>
          <span class="p-style-guide-code"
            ><strong>Element</strong>
            <code>&lt;h3&gt;</code> · <strong>Font</strong>
            <code>var(--font-heading)</code></span
          >
        </div>
        <div class="p-style-guide-type-item">
          <p class="u-body-font">
            Body copy uses <code>u-body-font</code> on paragraphs for Source Sans
            Pro.
          </p>
          <span class="p-style-guide-code"
            ><strong>Class</strong>
            <code>u-body-font</code> · <strong>Font</strong>
            <code>var(--font-body)</code></span
          >
        </div>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Buttons</h3>
      <p class="p-style-guide-code">
        Components <code>.btn</code>, variants <code>.btn-primary</code>,
        <code>.btn-secondary</code>
      </p>
      <div class="p-style-guide-code-demo">
        <div class="project-links p-style-guide-button-row">
          <a href="#" class="btn btn-primary">
            <span>Primary Action</span>
            <Icon name="external-link" />
          </a>
          <a href="#" class="btn btn-secondary">
            <Icon name="github" />
            Secondary Action
          </a>
          <button class="btn btn-secondary" type="button">
            <Icon name="github" />
            Button Element
          </button>
        </div>
        <p class="p-style-guide-code">
          <code>&lt;a class="btn btn-primary"&gt;...&lt;/a&gt;</code>
        </p>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Icon Library</h3>
      <div class="p-style-guide-icon-grid">
        {
          iconEntries.map((iconName) => (
            <div class="p-style-guide-icon">
              <div class="p-style-guide-icon-sample">
                <Icon name={iconName} />
              </div>
              <span class="p-style-guide-icon-name">{iconName}</span>
            </div>
          ))
        }
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Utilities</h3>
      <div class="p-style-guide-utility">
        <div>
          <h4 class="u-heading-font">Cluster</h4>
          <div class="cluster" style="--gap: 0.5rem">
            <button type="button" class="btn btn-secondary">One</button>
            <button type="button" class="btn btn-secondary">Two</button>
            <button type="button" class="btn btn-secondary">Three</button>
          </div>
          <p class="p-style-guide-code">
            <code
              >&lt;div class="cluster" style="--gap: 0.5rem"&gt;...&lt;/div&gt;</code
            >
          </p>
        </div>
        <div class="p-style-guide-tooltip-demo">
          <h4 class="u-heading-font">Tooltip</h4>
          <div class="project-link-wrapper">
            <button class="info-btn" aria-label="Show tooltip example">
              <Icon name="info-circle" />
            </button>
          </div>
          <div class="project-description">
            Hover to view the tooltip in action.
          </div>
          <p class="p-style-guide-code">
            Tooltip container is managed as a singleton <code>#tooltip</code>
            element created by <code>src/scripts/main.ts</code>.
          </p>
        </div>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Project Links</h3>
      <div class="p-style-guide-project-demo">
        <div class="project-link-wrapper">
          <a href="#">Telemetry Dashboard</a>
          <button class="info-btn" aria-label="Toggle project description">
            <Icon name="info-circle" />
          </button>
        </div>
        <div class="project-description">
          Comprehensive monitoring for edge devices with real-time alerts.
        </div>
        <div class="project-links">
          <a class="btn btn-primary" href="#">
            <span>Visit Website</span>
            <Icon name="external-link" />
          </a>
          <a class="btn btn-secondary" href="#">
            <Icon name="github" />
            GitHub
          </a>
        </div>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Project Card</h3>
      <p class="p-style-guide-code">
        Powered by <code>ProjectPreview</code> with the Maze Solver entry.
      </p>
      <div class="p-style-guide-preview">
        <div class="p-style-guide-project-preview">
          <ul
            class="projects-highlight-grid p-style-guide-project-grid"
            aria-label="Project card example"
          >
            <ProjectPreview
              project={mazeSolverProject}
              highlighted={mazeSolverProject.isHighlight}
            />
          </ul>
        </div>
        <p class="p-style-guide-note">
          The terminal-style preview comes straight from the Maze Solver demo.
        </p>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Code Block</h3>
      <div class="p-style-guide-preview">
        <Code code={pipelineCodeSample} lang="ts" />
        <p class="p-style-guide-note">
          Code blocks are themed and include line numbers and a copy button.
        </p>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>KaTeX Math</h3>
      <div class="p-style-guide-preview">
        <div class="p-style-guide-katex" set:html={katexExample} />
        <p class="p-style-guide-code">
          Render math with KaTeX: <code>{katexInline}</code>
        </p>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Article Previews</h3>
      <p class="p-style-guide-code">
        Mirrors the live blog feed cards with real post data.
      </p>
      <div class="p-style-guide-preview">
        <ul class="blog-index-list p-style-guide-blog-list">
          {
            previewPosts.map((post) => {
              const categoryLabel = getCategoryLabel(post.category);
              const hasTags = categoryLabel || post.tags.length > 0;
              return (
                <li class="blog-card">
                  <a class="blog-card__link" href={`/blog/${post.slug}/`}>
                    <p class="blog-card__meta">
                      <FormattedDate date={post.pubDate} /> · {post.readingTime}{" "}
                      min read
                    </p>
                    <h3 class="blog-card__title">{post.title}</h3>
                    <p class="blog-card__description">{post.description}</p>
                    {hasTags && (
                      <div class="blog-card__tags">
                        {categoryLabel && (
                          <span class="blog-card__tag blog-card__category-chip">
                            {categoryLabel}
                          </span>
                        )}
                        {post.tags.map((tag) => (
                          <span class="blog-card__tag">#{tag}</span>
                        ))}
                      </div>
                    )}
                  </a>
                </li>
              );
            })
          }
        </ul>
      </div>
    </article>

    <article class="p-style-guide-card">
      <h3>Copy & Prose</h3>
      <p class="p-style-guide-code">
        Body copy leans on concise paragraphs with purposeful verbs and
        occasional inline emphasis.
      </p>
      <div
        class="p-style-guide-preview p-style-guide-prose-preview"
        set:html={prosePreview}
      />
    </article>

    <article class="p-style-guide-card">
      <h3>remarkGithubAlerts</h3>
      <p class="p-style-guide-code">
        Blockquotes beginning with <code>[!NOTE]</code> or <code
          >[!WARNING]</code
        > become alert cards.
      </p>
      <div
        class="p-style-guide-preview p-style-guide-alert-preview"
        set:html={remarkAlertPreview}
      />
    </article>

    <article class="p-style-guide-card">
      <h3>Resume Components</h3>
      <div class="p-style-guide-grid">
        <div class="p-style-guide-card">
          <h4>Selected Result</h4>
          <p>Highlights a key achievement.</p>
          <div class="p-style-guide-preview">
            <ul class="resume-item-list">
              <li>
                <h3 class="resume-item__title">{firstResult.title}</h3>
                <p class="resume-item__body">{firstResult.description}</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="p-style-guide-card">
          <h4>Experience Section</h4>
          <p>A full preview of the experience list.</p>
          <div class="p-style-guide-preview">
            <section class="resume-section">
              <div class="resume-role">
                <div class="resume-role__header">
                  <div>
                    <h3>{experience.items[0].position}</h3>
                    <p class="resume-role__company">
                      <a
                        href={experience.items[0].url}
                        target="_blank"
                        rel="noopener noreferrer"
                        >{experience.items[0].company}</a
                      >
                    </p>
                  </div>
                  <p class="resume-role__date">
                    {experience.items[0].date}
                  </p>
                </div>
                <ul class="resume-role__bullets">
                  {
                    experience.items[0].highlights.map((highlight) => (
                      <li>{highlight}</li>
                    ))
                  }
                </ul>
              </div>
              <div class="resume-role">
                <div class="resume-role__header">
                  <div>
                    <h3>{experience.items[2].position}</h3>
                    <p class="resume-role__company">
                      <a
                        href={experience.items[2].url}
                        target="_blank"
                        rel="noopener noreferrer"
                        >{experience.items[2].company}</a
                      >
                    </p>
                  </div>
                  <p class="resume-role__date">
                    {experience.items[2].date}
                  </p>
                </div>
                <ul class="resume-role__bullets">
                  <li>{experience.items[2].highlights[0]}</li>
                  <li>{experience.items[2].highlights[1]}</li>
                </ul>
              </div>
            </section>
          </div>
        </div>
      </div>
    </article>
  </div>
</BaseLayout>
