---
import ProjectPreview from "../../components/ProjectPreview.astro";
import { getAllProjects, getHighlightedProjects } from "../../lib/projects";
import BaseLayout from "../../layouts/BaseLayout.astro";
import "../../styles/pages/projects-index.css";

const [projects, highlightedProjects] = await Promise.all([
  getAllProjects(),
  getHighlightedProjects(),
]);

const highlightedSlugs = new Set(
  highlightedProjects.map((project) => project.slug),
);

const nonNullable = <T,>(value: T | null | undefined): value is T =>
  value !== null && value !== undefined;

const prioritizedProjects = highlightedProjects.filter(nonNullable);

const sortedRemainder = projects
  .filter((project) => !highlightedSlugs.has(project.slug))
  .sort((a, b) => {
    const aDate = a.updatedDate ?? a.pubDate ?? "";
    const bDate = b.updatedDate ?? b.pubDate ?? "";
    if (!aDate && !bDate) return a.name.localeCompare(b.name);
    return new Date(bDate).getTime() - new Date(aDate).getTime();
  });

const orderedProjects = [...prioritizedProjects, ...sortedRemainder];

const pageTitle = "Projects";
const description = "All shipped experiments, products, and live demos.";
---

<BaseLayout
  title={`${pageTitle} â€“ Bogdan Ouatu`}
  description={description}
  mainClass="projects-page"
>
  <div class="projects-page-intro">
    <h1>{pageTitle}</h1>
    <p>{description}</p>
  </div>

  <h2 class="visually-hidden" id="projects-list-heading">Project listings</h2>

  <ul
    class="projects-highlight-grid projects-archive-grid"
    aria-labelledby="projects-list-heading"
  >
    {
      orderedProjects.map((project) => (
        <ProjectPreview
          project={project}
          highlighted={highlightedSlugs.has(project.slug)}
        />
      ))
    }
  </ul>
</BaseLayout>
