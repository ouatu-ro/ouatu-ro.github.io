---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProjectPreview from "../../components/ProjectPreview.astro";
import { getProjects, getHighlightConfig } from "../../utils/projects";
import ClientScripts from "../../components/ClientScripts.astro";
import "../../styles/pages/projects-index.css";

const [projects, highlights] = await Promise.all([
  getProjects(),
  getHighlightConfig(),
]);

const highlightOrder = highlights.projects.map((item) => item.slug);
const highlightedSlugs = new Set(highlightOrder);

const nonNullable = <T,>(value: T | null | undefined): value is T =>
  value !== null && value !== undefined;

const prioritizedProjects = highlightOrder
  .map((slug) => projects.find((project) => project.slug === slug))
  .filter(nonNullable);

const sortedRemainder = projects
  .filter((project) => !highlightedSlugs.has(project.slug))
  .sort((a, b) => {
    const aDate = a.updatedDate ?? a.pubDate ?? "";
    const bDate = b.updatedDate ?? b.pubDate ?? "";
    if (!aDate && !bDate) return a.name.localeCompare(b.name);
    return new Date(bDate).getTime() - new Date(aDate).getTime();
  });

const orderedProjects = [...prioritizedProjects, ...sortedRemainder];

const pageTitle = "Projects";
const description = "All shipped experiments, products, and live demos.";
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`${pageTitle} â€“ Bogdan Ouatu`} description={description} />
    <ClientScripts />
  </head>
  <body>
    <Header />
    <main class="projects-page">
      <div class="projects-page-intro">
        <h1>{pageTitle}</h1>
        <p>{description}</p>
      </div>

      <h2 class="visually-hidden" id="projects-list-heading">
        Project listings
      </h2>

      <ul
        class="projects-highlight-grid projects-archive-grid"
        aria-labelledby="projects-list-heading"
      >
        {
          orderedProjects.map((project) => (
            <ProjectPreview
              project={project}
              highlighted={highlightedSlugs.has(project.slug)}
            />
          ))
        }
      </ul>
    </main>
    <Footer />
  </body>
</html>
