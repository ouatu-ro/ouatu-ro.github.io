---
import type { CategoryId } from "@/config/site";
import { getAllTags } from "@/lib/posts";

interface Props {
  activeTag?: string;
  showAllLink?: boolean;
  categoryId?: CategoryId;
}

const { activeTag, showAllLink = true, categoryId } = Astro.props as Props;
const normalizedActive = activeTag?.toLowerCase();
const tags = await getAllTags(categoryId);
const hasTags = tags.length > 0;
const emptyMessage = categoryId
  ? "No tags for this category yet."
  : "No tags available yet.";

const baseHref = categoryId ? `/blog/${categoryId}` : "/blog/tag";
const tagHref = (slug: string) =>
  categoryId ? `${baseHref}/tag/${slug}/` : `${baseHref}/${slug}/`;
const allTopicsHref = categoryId ? `${baseHref}/` : "/blog/";
const ariaLabel = categoryId
  ? `Filter ${categoryId} posts by tag`
  : "Filter all posts by tag";
---

{
  !hasTags && (
    <div class="tag-dropdown tag-dropdown--placeholder">
      <span>{emptyMessage}</span>
    </div>
  )
}
{
  hasTags && (
    <details
      class={`tag-dropdown${normalizedActive ? " is-active" : ""}`}
      aria-label={ariaLabel}
      open={Boolean(normalizedActive)}
    >
      <summary>
        <span>Filter by topic</span>
        <span class="tag-dropdown__current">
          {normalizedActive ? `#${normalizedActive}` : "All topics"}
        </span>
        <span class="tag-dropdown__chevron" aria-hidden="true">
          â–¾
        </span>
      </summary>
      <div class="tag-dropdown__panel">
        <div class="tag-chip-row">
          {showAllLink && (
            <a
              class={`tag-chip${normalizedActive ? "" : " active"}`}
              href={allTopicsHref}
            >
              All topics
            </a>
          )}
          {tags.map((tag) => (
            <a
              class={`tag-chip${normalizedActive === tag.slug ? " active" : ""}`}
              href={tagHref(tag.slug)}
            >
              #{tag.label}
            </a>
          ))}
        </div>
      </div>
    </details>
  )
}
