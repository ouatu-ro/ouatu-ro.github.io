---
import type { ProjectRecord } from "../lib/projects";
import "../styles/components/project-preview.css";
import {
  buildProjectArtworkContext,
  previewComponentMap,
} from "./project-artwork-context";

interface Props {
  project: ProjectRecord;
  highlighted?: boolean;
}

const { project, highlighted = false } = Astro.props;

// Prefer showing media preview whenever a preview asset exists.
// Some entries gate via shouldShowPreview in content, but index should
// still render media if available.
const previewAsset = project.previewAsset ?? null;
const assetIsVideo = previewAsset
  ? /\.(mp4|webm|mov|m4v)$/i.test(previewAsset)
  : false;
const assetIsImage = previewAsset
  ? /\.(png|jpe?g|gif|webp|avif)$/i.test(previewAsset)
  : false;
const hasMedia = Boolean(previewAsset && (assetIsVideo || assetIsImage));
const artworkContext = buildProjectArtworkContext(project);
const {
  trimmedDescription,
  terminalLines,
  codeLines,
  blueprintNodes,
  blueprintConnectors,
  graphNodes,
  graphLinks,
  previewType,
  promptName,
  pascalName,
} = artworkContext;

let projectDomain = "";
try {
  projectDomain = new URL(project.homepage).hostname.replace(/^www\./, "");
} catch {}

let githubLabel = "";
if (project.githubUrl) {
  try {
    githubLabel = new URL(project.githubUrl).pathname.slice(0, 30) || "GitHub";
  } catch {
    githubLabel = "GitHub";
  }
}

const ArtworkComponent =
  previewComponentMap[previewType as keyof typeof previewComponentMap] ??
  previewComponentMap.titlecard;
---

<li class="project-card">
  <a class="project-card-link" href={`/project/${project.slug}`}>
    {highlighted && <span class="project-card-badge">Featured</span>}

    {
      hasMedia ? (
        <div class="project-card-media">
          {assetIsVideo ? (
            <video
              autoplay
              data-src={previewAsset!}
              preload="none"
              playsinline
              muted
              loop
              aria-label={`Preview recording for ${project.name}`}
            />
          ) : (
            <img
              src={previewAsset!}
              alt={`Preview for ${project.name}`}
              loading="lazy"
              decoding="async"
            />
          )}
        </div>
      ) : (
        <div
          class:list={[
            "project-card-media",
            "project-card-media--fallback",
            `project-card-media--${previewType}`,
          ]}
        >
          <ArtworkComponent
            project={project}
            trimmedDescription={trimmedDescription}
            promptName={promptName}
            pascalName={pascalName}
            terminalLines={terminalLines}
            codeLines={codeLines}
            blueprintNodes={blueprintNodes}
            blueprintConnectors={blueprintConnectors}
            graphNodes={graphNodes}
            graphLinks={graphLinks}
            label={project.name.slice(0, 2).toUpperCase()}
            title={project.name}
            subtitle={trimmedDescription}
            domain={projectDomain || project.name}
          />
        </div>
      )
    }

    <div class="project-card-body">
      <h3>{project.name}</h3>
      <p>{trimmedDescription}</p>
      <div class="project-card-meta">
        {projectDomain && <span>Live · {projectDomain}</span>}
        {project.githubUrl && <span>Code · {githubLabel || "GitHub"}</span>}
      </div>
    </div>
  </a>
</li>

<script is:inline>
  if (typeof window !== "undefined") {
    const w = window;
    if (!w.__projectPreviewObserver) {
      w.__projectPreviewObserver = new IntersectionObserver(
        function (entries, observer) {
          entries.forEach(function (entry) {
            if (!entry.isIntersecting) return;
            const video = entry.target;
            const dataSrc = video.getAttribute("data-src");
            if (dataSrc && !video.getAttribute("src")) {
              video.setAttribute("src", dataSrc);
              video.load();
              video.play().catch(function () {});
            }
            observer.unobserve(video);
          });
        },
        { rootMargin: "600px 0px", threshold: 0.01 },
      );
    }

    const viewportH =
      window.innerHeight || document.documentElement.clientHeight;
    document
      .querySelectorAll(".project-card-media video[data-src]")
      .forEach(function (video) {
        if (video.getAttribute("data-observed")) return;
        video.setAttribute("data-observed", "true");

        const setAndPlay = function () {
          const dataSrc = video.getAttribute("data-src");
          if (dataSrc && !video.getAttribute("src")) {
            video.setAttribute("src", dataSrc);
            video.load();
            video.play().catch(function () {});
          }
        };

        const rect = video.getBoundingClientRect();
        const nearViewport = rect.top <= viewportH + 600 && rect.bottom >= -600;
        if (nearViewport) {
          setAndPlay();
          return;
        }

        w.__projectPreviewObserver.observe(video);
        setTimeout(function () {
          if (!video.getAttribute("src")) setAndPlay();
        }, 250);
      });
  }
</script>
